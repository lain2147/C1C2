<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>電子零件BOM表OCR辨識工具</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 28px;
        margin-bottom: 10px;
      }

      .header p {
        opacity: 0.9;
        font-size: 14px;
      }

      .content {
        padding: 30px;
      }

      .upload-section {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }

      .upload-box {
        flex: 1;
        min-width: 250px;
        border: 3px dashed #667eea;
        border-radius: 15px;
        padding: 40px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        background: #f8f9ff;
      }

      .upload-box:hover {
        border-color: #764ba2;
        background: #f0f2ff;
        transform: translateY(-2px);
      }

      .upload-box input[type="file"] {
        display: none;
      }

      .upload-box svg {
        width: 50px;
        height: 50px;
        margin-bottom: 15px;
        color: #667eea;
      }

      .upload-box h3 {
        color: #333;
        margin-bottom: 10px;
      }

      .upload-box p {
        color: #666;
        font-size: 14px;
      }

      .preview-section {
        margin-bottom: 30px;
        display: none;
      }

      .preview-section.active {
        display: block;
      }

      .preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 15px;
        background: #f5f5f5;
        border-radius: 10px;
      }

      .preview-header h3 {
        color: #333;
        font-size: 18px;
      }

      .image-count {
        background: #667eea;
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: bold;
      }

      .images-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
      }

      .image-item {
        position: relative;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s;
      }

      .image-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      }

      .image-item img {
        width: 100%;
        height: 200px;
        object-fit: cover;
        display: block;
      }

      .image-item .remove-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255, 0, 0, 0.8);
        color: white;
        border: none;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 18px;
        line-height: 1;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .image-item .remove-btn:hover {
        background: rgba(255, 0, 0, 1);
        transform: scale(1.1);
      }

      .image-number {
        position: absolute;
        bottom: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 12px;
        font-weight: bold;
      }

      .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 15px 40px;
        border-radius: 25px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.6);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background: #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        margin: 20px 0;
        display: none;
      }

      .progress-bar.active {
        display: block;
      }

      .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        width: 0%;
        transition: width 0.3s;
      }

      .progress-details {
        display: none;
        margin: 10px 0;
        padding: 15px;
        background: #f5f5f5;
        border-radius: 8px;
        font-size: 14px;
        color: #666;
      }

      .progress-details.active {
        display: block;
      }

      .progress-step {
        display: flex;
        align-items: center;
        margin: 8px 0;
      }

      .progress-step-icon {
        width: 20px;
        height: 20px;
        margin-right: 10px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
      }

      .progress-step-icon.completed {
        background: #4caf50;
        color: white;
      }

      .progress-step-icon.processing {
        background: #2196f3;
        color: white;
        animation: pulse 1s infinite;
      }

      .progress-step-icon.pending {
        background: #e0e0e0;
        color: #999;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .performance-stats {
        display: none;
        margin: 15px 0;
        padding: 15px;
        background: #e3f2fd;
        border-radius: 8px;
        border-left: 4px solid #2196f3;
      }

      .performance-stats.active {
        display: block;
      }

      .performance-stats h4 {
        color: #1976d2;
        margin-bottom: 10px;
        font-size: 16px;
      }

      .stat-item {
        display: flex;
        justify-content: space-between;
        margin: 5px 0;
        font-size: 14px;
        color: #333;
      }

      .stat-value {
        font-weight: bold;
        color: #1976d2;
      }

      .status {
        text-align: center;
        padding: 15px;
        margin: 20px 0;
        border-radius: 10px;
        display: none;
      }

      .status.active {
        display: block;
      }

      .status.info {
        background: #e3f2fd;
        color: #1976d2;
      }

      .status.success {
        background: #e8f5e9;
        color: #388e3c;
      }

      .status.error {
        background: #ffebee;
        color: #d32f2f;
      }

      .results-section {
        margin-top: 30px;
        display: none;
      }

      .results-section.active {
        display: block;
      }

      .result-group {
        margin-bottom: 25px;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
      }

      .result-group-header {
        background: #f5f5f5;
        padding: 15px 20px;
        font-weight: bold;
        color: #333;
        border-bottom: 1px solid #e0e0e0;
      }

      .result-group-content {
        padding: 20px;
      }

      .component-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 15px;
      }

      .component-tag {
        background: #667eea;
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 14px;
      }

      .missing-list {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 8px;
        padding: 15px;
      }

      .missing-list h4 {
        color: #ff6f00;
        margin-bottom: 10px;
      }

      .missing-tag {
        background: #ff6f00;
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 14px;
        display: inline-block;
        margin: 5px;
      }

      .button-group {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 30px;
      }

      #cameraModal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }

      #cameraModal.active {
        display: flex;
      }

      .camera-container {
        position: relative;
        max-width: 90%;
        max-height: 90%;
      }

      #video {
        max-width: 100%;
        max-height: 80vh;
        border-radius: 10px;
      }

      #canvas {
        display: none;
      }

      .camera-controls {
        text-align: center;
        margin-top: 20px;
      }

      .camera-controls button {
        margin: 0 10px;
      }

      /* 新增：預處理選項和手動輸入的樣式 */
      .preprocessing-section,
      .manual-input-section {
        margin-bottom: 25px;
        padding: 20px;
        background: #f5f5f5;
        border-radius: 10px;
        border: 2px solid #e0e0e0;
      }

      .preprocessing-controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 12px;
        margin-bottom: 10px;
      }

      .checkbox-label {
        display: flex;
        align-items: center;
        cursor: pointer;
        padding: 10px;
        background: white;
        border-radius: 8px;
        transition: all 0.3s;
      }

      .checkbox-label:hover {
        background: #e8f4f8;
        transform: translateX(5px);
      }

      .checkbox-label input[type="checkbox"] {
        margin-right: 10px;
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .checkbox-label span {
        color: #333;
        font-size: 14px;
      }

      .preprocessing-note {
        color: #666;
        font-size: 13px;
        margin-top: 10px;
        padding: 10px;
        background: #fff3cd;
        border-radius: 5px;
        border-left: 4px solid #ffc107;
      }

      #manualInput {
        width: 100%;
        padding: 12px;
        border: 2px solid #ccc;
        border-radius: 8px;
        font-family: "Courier New", monospace;
        font-size: 14px;
        resize: vertical;
        transition: border-color 0.3s;
      }

      #manualInput:focus {
        outline: none;
        border-color: #667eea;
      }

      .btn-secondary {
        background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
      }

      .btn-secondary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(76, 175, 80, 0.6);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>電子零件BOM表OCR辨識工具</h1>
        <p>
          上傳圖片或拍照辨識零件編號（C1, R1,
          L1等），自動找出缺失序號並匯出Excel
        </p>
      </div>

      <div class="content">
        <div class="upload-section">
          <div
            class="upload-box"
            onclick="document.getElementById('fileInput').click()"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
              />
            </svg>
            <h3>上傳圖片</h3>
            <p>可選擇多張圖片</p>
            <input type="file" id="fileInput" accept="image/*" multiple />
          </div>

          <div class="upload-box" onclick="openCamera()">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"
              />
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"
              />
            </svg>
            <h3>拍照</h3>
            <p>使用相機拍攝BOM表</p>
          </div>
        </div>

        <!-- OCR 引擎選擇 -->
        <div
          class="ocr-engine-section"
          style="
            margin-bottom: 25px;
            padding: 20px;
            background: #f0f7ff;
            border-radius: 10px;
            border: 2px solid #2196f3;
          "
        >
          <h3 style="color: #333; margin-bottom: 15px; font-size: 16px">
            OCR 引擎
          </h3>
          <div style="margin-bottom: 15px">
            <label
              style="
                display: flex;
                align-items: center;
                margin-bottom: 10px;
                cursor: pointer;
              "
            >
              <input
                type="radio"
                name="ocrEngine"
                value="deepseek"
                id="ocrEngineDeepseek"
                style="margin-right: 10px"
              />
              <span style="font-weight: bold; color: #1976d2"
                >DeepSeek（需自建後端 API）</span
              >
            </label>
            <div style="margin-left: 28px; margin-bottom: 15px">
              <p style="color: #666; font-size: 13px; margin-bottom: 8px">
                選擇此項目時，會將圖片 Base64 POST 到您設定的 DeepSeek 代理端點（需自備金鑰與後端，避免金鑰曝光）。
              </p>
              <label
                style="
                  display: block;
                  margin-bottom: 5px;
                  font-size: 14px;
                  color: #333;
                "
              >
                DeepSeek API 代理端點：
              </label>
              <input
                type="text"
                id="deepseekEndpoint"
                placeholder="例如：https://your-backend.example.com/deepseek-ocr"
                value="http://localhost:3000/deepseek-ocr"
                style="
                  width: 100%;
                  padding: 10px;
                  border: 1px solid #ccc;
                  border-radius: 5px;
                  font-family: monospace;
                  font-size: 13px;
                  margin-bottom: 8px;
                "
              />
              <label
                style="
                  display: block;
                  margin-bottom: 5px;
                  font-size: 14px;
                  color: #333;
                "
              >
                DeepSeek API Key（前端暫存傳送到代理端，不會儲存）：
              </label>
              <input
                type="password"
                id="deepseekApiKey"
                placeholder="請輸入您的 DeepSeek API Key（本地代理已可留空）"
                style="
                  width: 100%;
                  padding: 10px;
                  border: 1px solid #ccc;
                  border-radius: 5px;
                  font-family: monospace;
                  font-size: 13px;
                "
              />
              <p style="color: #ff6f00; font-size: 12px; margin-top: 5px">
                提醒：請勿將金鑰硬編碼在前端，建議以後端代理呼叫 DeepSeek。
              </p>
            </div>

            <label
              style="
                display: flex;
                align-items: center;
                margin-bottom: 10px;
                cursor: pointer;
              "
            >
              <input
                type="radio"
                name="ocrEngine"
                value="tesseract"
                id="ocrEngineTesseract"
                checked
                style="margin-right: 10px"
              />
              <span style="font-weight: bold; color: #666"
                >Tesseract.js（本地離線）</span
              >
            </label>
            <p style="color: #666; font-size: 13px; margin-left: 28px">
              ✅ 完全離線 ✅ 免費無限制<br />
              ⚠️ 辨識速度較慢 ⚠️ 準確度較低
            </p>
          </div>
        </div>
        
        <!-- 手動輸入零件編號 -->
        <div class="manual-input-section">
          <h3 style="color: #333; margin-bottom: 15px; font-size: 16px">
            ✏️ 手動輸入零件編號
          </h3>
          <p style="color: #666; font-size: 14px; margin-bottom: 10px">
            從其他文件複製零件編號，將自動加入統計（支援多行，自動識別格式）
          </p>
          <textarea
            id="manualInput"
            placeholder="範例：
C1, C2, C3, C5
R10 R11 R15
L1|L2|L3
D5, D7, D8

支援格式：逗號、空格、|符號分隔
可多行輸入"
            rows="6"
          ></textarea>
          <button class="btn-secondary" onclick="addManualComponents()">
            加入零件編號
          </button>
          <div
            id="manualComponentsPreview"
            style="margin-top: 10px; color: #666; font-size: 14px"
          ></div>
        </div>

        <div class="preview-section" id="previewSection">
          <div class="preview-header">
            <h3>已選擇的圖片</h3>
            <span class="image-count" id="imageCount">0 張</span>
          </div>
          <div class="images-gallery" id="imagesGallery"></div>
        </div>

        <div class="progress-bar" id="progressBar">
          <div class="progress-bar-fill" id="progressBarFill"></div>
        </div>

        <div class="progress-details" id="progressDetails">
          <div class="progress-step">
            <div class="progress-step-icon pending" id="step1Icon">1</div>
            <span id="step1Text">圖片預處理（矯正、壓縮、增強）</span>
          </div>
          <div class="progress-step">
            <div class="progress-step-icon pending" id="step2Icon">2</div>
            <span id="step2Text">OCR文字辨識</span>
          </div>
          <div class="progress-step">
            <div class="progress-step-icon pending" id="step3Icon">3</div>
            <span id="step3Text">零件編號解析</span>
          </div>
        </div>

        <div class="status" id="status"></div>

        <div class="performance-stats" id="performanceStats">
          <h4>⚡ 性能統計</h4>
          <div class="stat-item">
            <span>處理模式：</span>
            <span class="stat-value" id="processingMode">-</span>
          </div>
          <div class="stat-item">
            <span>總處理時間：</span>
            <span class="stat-value" id="totalTime">-</span>
          </div>
          <div class="stat-item">
            <span>平均每張：</span>
            <span class="stat-value" id="avgTime">-</span>
          </div>
          <div class="stat-item">
            <span>辨識準確度：</span>
            <span class="stat-value" id="avgConfidence">-</span>
          </div>
        </div>

        <div class="button-group">
          <button
            class="btn"
            id="analyzeBtn"
            onclick="analyzeImage()"
            style="display: none"
          >
            開始辨識
          </button>
        </div>

        <div class="results-section" id="resultsSection">
          <h2 style="margin-bottom: 20px; color: #333">辨識結果</h2>
          <div id="resultsContainer"></div>

          <div class="button-group">
            <button class="btn" onclick="exportToExcel()">匯出Excel</button>
            <button
              class="btn"
              onclick="resetApp()"
              style="
                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
              "
            >
              重新開始
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="cameraModal">
      <div class="camera-container">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
        <div class="camera-controls">
          <button class="btn" onclick="capturePhoto()">拍照並繼續</button>
          <button
            class="btn"
            onclick="finishCamera()"
            style="
              background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            "
          >
            完成
          </button>
          <button
            class="btn"
            onclick="closeCamera()"
            style="
              background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            "
          >
            取消
          </button>
        </div>
      </div>
    </div>

    <script src="image-alignment.js"></script>
    <script src="image-processor.js"></script>
    <script src="worker-pool.js"></script>
    <script src="deepseek-ocr.js"></script>
    <script src="app.js"></script>
  </body>
</html>
